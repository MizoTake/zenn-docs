---
title: "GodotEngineã§dmxã®ä¿¡å·ã‚’å—ã‘å–ã£ã¦ã¿ãŸ"
emoji: "ğŸ’¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: 
  - "godot"
  - "dmx"
  - "csharp"
published: true
---

# GodotEngineã‚’è§¦ã£ã¦ã¿ãŸã„

å‰ã€…ã‹ã‚‰æ°—ã«ãªã£ã¦ãŸGodotEngineã‚’è§¦ã£ã¦ã¿ã‚ˆã†ã¨æ€ã„åˆã‚ã¦è§¦ã£ã¦ã¿ã¾ã—ãŸã€‚
æ¦‚å¿µã®ç†è§£ãŒã¡ã‚ƒã‚“ã¨ã¾ã ã§ãã¦ãªã„ã®ã§æ‰‹æ¢ã‚Šã§ã™ãŒä¸€æ—¦ç›®æ¨™ã¨ã—ã¦ã€ç…§æ˜æ©Ÿå™¨ã®æ“ä½œãªã©ã«ç”¨ã„ã‚‰ã‚Œã‚‹DMXä¿¡å·ã‚’å—ã‘å–ã‚‹ã¨ã“ã‚ã¾ã§ã‚’ã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚

ä»Šå›å‹•ã„ãŸã‚‚ã®ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«å…¥ã‚Œã¦ã¾ã™ã€‚
https://github.com/MizoTake/recieve-dmx-godot

# ç’°å¢ƒ

- GodotEngine: v4.1.1.stable.mono.official [bd6af8e0e]
- [LXProtocols.ArtNet](https://www.nuget.org/packages/LXProtocols.ArtNet) 3.0.4.2
- [QLC+](https://www.qlcplus.org/)

ä»¥ä¸‹ã‹ã‚‰æ‰‹é †ã«ã¤ã„ã¦æ›¸ãã¾ã™ãŒQLCãªã©ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ã¯çœãã¾ã™ã€‚

# æ‰‹é †

## GodotEngineã§ã‚·ãƒ¼ãƒ³ã‚’ç”¨æ„ã™ã‚‹

tscnãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ã¨ã—ã¦ `DMXReceiver` ã‚’é…ç½®ã—ã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/de51e5e0953d-20230917.png)

ã“ã®ãƒãƒ¼ãƒ‰ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚’ä½¿ã£ã¦ä»Šå›ã¯DMXã‚’å—ã‘å–ã‚‹å‡¦ç†ã‚’ä½œæˆã—ã¾ã™ã€‚

## QLC+ã®è¨­å®šã‚’è¡Œã†

Universeã¯4ã¤ã§ `127.0.0.1` ã«å¯¾ã—ã¦å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¦ãŠãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/ccbf77c4b5c8-20230917.png)

ã¾ãŸã€æ©Ÿå™¨ã¯é©å½“ã«è¨­å®šã—ã¦å…¨ãƒãƒ£ãƒ³ãƒãƒ«ã‚’ä¸€æ‹¬ã§ä»Šå›ã¯æ“ä½œã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/c585a202f147-20230917.gif)

ã“ã‚Œã§ã²ã¨ã¾ãšDMXä¿¡å·ã‚’æµã™æº–å‚™ãŒã§ãã¾ã—ãŸã€‚

## LXProtocols.ArtNetã‚’å°å…¥ã™ã‚‹

ä»Šå›ç§ã®ç’°å¢ƒã§ã¯Riderã‚’ä½¿ã£ã¦ã„ãŸã®ã§RiderçµŒç”±ã§NuGetã‚’ä½¿ç”¨ã—ã¦å°å…¥ã—ã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/2c6ed493b95f-20230917.png)

Riderã§ã¯å°‚ç”¨ã®ã‚¿ãƒ–ãŒã‚ã‚‹ã®ã§ãã“ã‹ã‚‰æ¤œç´¢ã§ `artnet` ã‚’å…¥åŠ›ã™ã‚‹ã“ã¨ã§æ¢ã—å‡ºã›ã¾ã™ã€‚ãã“ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦å°å…¥ã—ã¦ã„ã¾ã™ã€‚

### ä»–ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«ã¤ã„ã¦

[Haukcode.ArtNet](https://www.nuget.org/packages/Haukcode.ArtNet) ã¨ã„ã†ã‚‚ã®ã‚’å½“åˆå°å…¥ã—ã‚ˆã†ã¨ã—ãŸã®ã§ã™ãŒä»Šå›QLC+ã§ `127.0.0.1` ã®ãƒ«ãƒ¼ãƒ—ãƒãƒƒã‚¯ã§æµãã†ã¨ã™ã‚‹ã¨ã†ã¾ãå—ã‘å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã§æµã•ãšã«ä»–ã®æ©Ÿå™¨ã‹ã‚‰ãªã‚‰å—ã‘å–ã‚ŒãŸã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## DMXã‚’å—ã‘å–ã‚‹éƒ¨åˆ†ã‚’ä½œæˆã™ã‚‹

DMXRecieverãŒNodeã«ç›´æ¥ç´ã¥ã‘ã¦ã„ã‚‹éƒ¨åˆ†ã§ã™ã€‚
ã‚¤ãƒ³ã‚¹ãƒšã‚¯ã‚¿ãƒ¼ã‹ã‚‰IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¨DMXã®Universeè¨­å®šã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
`CaptureArtNetSignal.cs` ã¨ã„ã†å¾Œã§è¨˜è¼‰ã™ã‚‹ç›´æ¥DMXä¿¡å·ã‚’å—ã‘å–ã‚‹ã‚¯ãƒ©ã‚¹ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ã€ãã“ã‹ã‚‰ä¿¡å·ã‚’å—ã‘ã¦ãƒ­ã‚°ã‚’æµã™ã‚ˆã†ã«ä¸€æ—¦ã—ã¦ã„ã¾ã™ã€‚
æœ¬æ¥ã§ã‚ã‚Œã°ä¿¡å·å—ã‘å–ã£ã¦CGç…§æ˜ãªã©ã«åæ˜ ã•ã›ã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã¨æ€ã†ã®ã§ã™ãŒä»Šå›ã¯ä¿¡å·å—ã‘å–ã‚‹ã¨ã“ã‚ã¾ã§ã®æƒ³å®šãªã®ã§ãƒ­ã‚°å‡ºã—ã ã‘ã§ã™ã€‚

:::details DMXReciever.cs

![](https://storage.googleapis.com/zenn-user-upload/2e1c76a98ac1-20230917.png)

```csharp:DMXReciever.cs
using System;
using System.Net;
using System.Text;
using Godot;
using GodotProject.scripts;

namespace GodotProject.scripts;

public partial class DMXReciever : Node
{

	[Export]
	private string ipAddressString = "127.0.0.1";
	[Export]
	private string subnetMaskAddressString = "255.0.0.0";
	[Export]
	private uint universe = 4;

	private byte[] signals;
	private StringBuilder stringBuilder = new();
	private CaptureArtNetSignal captureArtNetSignal;

	public override void _Ready()
	{
		var ipAddress = IPAddress.Parse(ipAddressString);
		var subnetMaskAddress = IPAddress.Parse(subnetMaskAddressString);
		captureArtNetSignal = new CaptureArtNetSignal(ipAddress, subnetMaskAddress, universe);
		captureArtNetSignal.OnNotifySignals += OnNotifySignals;
	}

	private void OnNotifySignals(in byte[] signals)
	{
		this.signals = signals;
		stringBuilder.Clear();
		for (var i = 0; i < this.signals.Length; i++)
		{
			stringBuilder.AppendLine($"{i}: {signals[i]}");
		}
		GD.Print(stringBuilder.ToString());
	}

	public override void _ExitTree()
	{
		captureArtNetSignal.OnNotifySignals -= OnNotifySignals;
		(captureArtNetSignal as IDisposable).Dispose();
	}
}
```

:::

CaptureArtNetSignalã¨ã„ã†ã‚¯ãƒ©ã‚¹ã§LXProtocols.ArtNetã®å‘¼ã³å‡ºã—ãªã©ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚


:::details CaptureArtNetSignal.cs

```csharp:CaptureArtNetSignal.cs
using System;
using System.Net;
using Godot;
using LXProtocols.Acn.Rdm;
using LXProtocols.Acn.Sockets;
using LXProtocols.ArtNet;
using LXProtocols.ArtNet.Packets;
using LXProtocols.ArtNet.Sockets;

namespace GodotProject.scripts;

public class CaptureArtNetSignal : IDisposable
{

    private const uint DmxLengthPerUniverse = 512;
    
    private readonly ArtNetSocket socket = new (UId.Empty);
    private byte[] dmxData;

    public delegate void NotifyNewPacket(in byte[] signals);
    public event NotifyNewPacket OnNotifySignals;
    
    public CaptureArtNetSignal(IPAddress ipAddress, IPAddress subnetMaskAddress, uint universe)
    {
        dmxData = new byte[DmxLengthPerUniverse * universe];

        socket.NewPacket += SocketOnNewPacket;
        socket.UnhandledException += SocketOnUnhandledException;

        socket.Open(ipAddress, subnetMaskAddress);
    }

    private void SocketOnUnhandledException(object sender, UnhandledExceptionEventArgs e)
    {
        var exception = e.ExceptionObject as Exception;
        GD.PrintErr(exception);
    }

    private void SocketOnNewPacket(object sender, NewPacketEventArgs<ArtNetPacket> e)
    {
        switch (e.Packet.OpCode) {
            case ArtNetOpCodes.Dmx:
                var dmxPacket = e.Packet as ArtNetDmxPacket;
                Array.Copy(dmxPacket.DmxData, 0, dmxData, DmxLengthPerUniverse * dmxPacket.Universe, DmxLengthPerUniverse);
                OnNotifySignals?.Invoke(dmxData);
                break;
        }
    }

    void IDisposable.Dispose()
    {
        socket.UnhandledException -= SocketOnUnhandledException;
        socket.NewPacket -= SocketOnNewPacket;
        socket.Close();
        socket.Dispose();
    }
}
```

:::

## ä¿¡å·ã‚’å—ã‘å–ã£ã¦ã¿ã‚‹

QLC+ã§ä¿¡å·ã‚’æµã—ã¦Godotã§ãƒ­ã‚°ã‚’æµã—ãŸç”»åƒã§ã™ã€‚
è¨­å®šã—ãŸæ•°å€¤ãŒåæ˜ ã•ã‚Œã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/5f54ccc95cbd-20230917.png)

ã¾ãŸå…¨ä½“ã ã‘ã§ãªãç‰¹å®šã®ãƒãƒ£ãƒ³ãƒãƒ«ã‚’æ“ä½œã—ã¦ã‚‚æƒ³å®šã—ãŸæ•°å€¤ã®åæ˜ ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/be4d6879f73b-20230917.png)

# æœ€æœŸã«

Godotã‚’åˆã‚ã¦è§¦ã‚Šã¤ã¤C#è§¦ã‚Œã¦ã¿ã¦æ€ã£ãŸã‚ˆã‚Šã‚‚é›£ã—ããªãè§¦ã‚ŒãŸå°è±¡ã§ã—ãŸã€‚
ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å°å…¥ã‚‚NuGetã§ã‚µã‚¯ãƒƒã¨å°å…¥ã§ããŸã‚Šã‚¤ãƒ³ã‚¹ãƒšã‚¯ã‚¿ãƒ¼ã¸ã®åæ˜ ãªã©ä½¿ã„ã‚„ã™ã‹ã£ãŸã§ã™ã€‚
Engineã¨ã—ã¦ã®æ©Ÿèƒ½ã‚‚å°‘ã—ãšã¤è§¦ã£ã¦ã¿ã‚ŒãŸã‚‰ã¨æ€ã„ã¾ã™ã€‚