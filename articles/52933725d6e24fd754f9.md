---
title: "OVRLipSyncMicInputã‚’ä½¿ã†ã¨ãã«ãƒã‚¤ã‚¯ã®é¸æŠã‚’ç°¡å˜ã«ã—ãŸã„"
emoji: "ğŸ‘„"
type: "tech"
topics:
  - "csharp"
  - "unity"
  - "vrm"
  - "ovr"
published: true
published_at: "2020-11-01 18:09"
---

## OVRLipSyncMicInputã‚’ä½¿ã†ã¨ãã«ãƒã‚¤ã‚¯ã®é¸æŠãŒã‚ã‚“ã©ãã•ã‹ã£ãŸ

VRMãƒ¢ãƒ‡ãƒ«ã‚’OVRLipSyncã‚’ä½¿ã£ã¦å£ã‚’å‹•ã‹ãã†ã¨æ€ã£ãŸæ™‚ã«ã‚¹ãƒ ãƒ¼ã‚ºã«ãƒã‚¤ã‚¯ã®åˆ‡ã‚Šæ›¿ãˆãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ `OVRLipSyncMicInput.cs` ã‚’ä½¿ã£ã¦è¡ŒãŠã†ã¨ã—ãŸã‚‰

|Playå‰|Playå¾Œ|
|---|---|
|![](https://storage.googleapis.com/zenn-user-upload/1gjgzoc45ey414849ee9zn035td2)|![](https://storage.googleapis.com/zenn-user-upload/h3alkb1vef95iddme31lkqkejk3x)|

ä½¿ã£ã¦ã„ã‚‹ãƒã‚¤ã‚¯ã‚’ç¤ºã—ã¦ã„ã‚‹ä¸€ç•ªä¸‹ã«ã‚ã‚‹é …ç›® `Selected Device` ã«ã¯ãƒã‚¤ã‚¯ã‚’é…åˆ—ã§å–å¾—ã—ã¦æœ€åˆã®è¦ç´ ã®æ–‡å­—åˆ—ãŒå…¥ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ãã‚ŒãŒä½¿ã†ã‚‚ã®ã¨ã—ã¦å‹•ä½œã—ã¾ã™ã€‚åˆ‡ã‚Šæ›¿ãˆã‚‹ã«ã¯ `OVRLipSyncMicInput.cs` ã‚’ã„ã˜ã‚‹ã‹å¤–éƒ¨ã‹ã‚‰å·®ã—è¾¼ã‚€ã—ã‹ãªã‹ã£ãŸã®ã§å·®ã—è¾¼ã‚€ã“ã¨ã«ã—ã¾ã—ãŸã€‚


## ä½œã£ãŸã‚‚ã®

ä»Šå›ä½œã£ãŸã®ã¯VRMãƒ¢ãƒ‡ãƒ«ã«LipSyncã‚’ã™ã‚‹ã‚‚ã®ã«ãªã‚Šã¾ã™ã®ã§ãã®éƒ¨åˆ†ã‚’å«ã‚“ã csã«ãªã‚Šã¾ã™ã€‚UnityEditorã®ã¿ã®å‹•ä½œã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

:::details VRMLipSyncContextMorphTarget.cs

```cs:VRMLipSyncContextMorphTarget.cs
using System.Collections.Generic;
using System.Linq;
#if UNITY_EDITOR
using UnityEditor;
#endif
using UnityEngine;
using VRM;

namespace Component
{
    [RequireComponent(typeof(OVRLipSyncMicInput))]
    [DefaultExecutionOrder(10000)]
    public class VRMLipSyncContextMorphTarget : OVRLipSyncContext
    {

        [SerializeField] private VRMBlendShapeProxy shapeProxy;
        [SerializeField, Range(0.0f, 2.0f)] private float visemesVolume = 2.0f;
        
	[HideInInspector] public string selected;

        private BlendShapePreset[] visemePresets = {
            BlendShapePreset.Neutral,
            BlendShapePreset.Unknown,
            BlendShapePreset.Unknown,
            BlendShapePreset.Unknown,
            BlendShapePreset.Unknown,
            BlendShapePreset.Unknown,
            BlendShapePreset.Unknown,
            BlendShapePreset.Unknown,
            BlendShapePreset.Unknown,
            BlendShapePreset.Unknown,
            BlendShapePreset.A,
            BlendShapePreset.E,
            BlendShapePreset.I,
            BlendShapePreset.O,
            BlendShapePreset.U
        };

        private void Start()
        {
            var micInput = GetComponent<OVRLipSyncMicInput>();
            micInput.StopMicrophone();
            micInput.selectedDevice = selected;
            micInput.StartMicrophone();
        }

        void LateUpdate()
        {
            if (shapeProxy == null) return;
            var frame = GetCurrentPhonemeFrame();
            var values = visemePresets.Select((preset, i) => BlendShapePairBuilder(preset, frame.Visemes[i]));
            shapeProxy.SetValues(values);
        }

        private KeyValuePair<BlendShapeKey, float> BlendShapePairBuilder(BlendShapePreset preset, float viseme)
        {
            return new KeyValuePair<BlendShapeKey, float>(BlendShapeKey.CreateFromPreset(preset), viseme * visemesVolume);
        }
    }
    
#if UNITY_EDITOR

    [CustomEditor(typeof(VRMLipSyncContextMorphTarget))]
    public class VRMLipSyncContextMorphTargetEditor : Editor
    {

        private VRMLipSyncContextMorphTarget vrmLipSyncContextMorphTarget;
        private int selectedIndex;
        private string selectedIndexKey = $"{nameof(VRMLipSyncContextMorphTarget)}.{nameof(selectedIndex)}";

        void OnEnable()
        {
            vrmLipSyncContextMorphTarget = (VRMLipSyncContextMorphTarget)target;
        }

        public override void OnInspectorGUI()
        {
            DrawDefaultInspector();
            
            EditorGUI.BeginChangeCheck();

            selectedIndex = EditorPrefs.GetInt(selectedIndexKey);
            
            var micDevices = Microphone.devices;
            var label = "Select Microphone";
            var index = micDevices.Length > 0 && selectedIndex < micDevices.Length ? EditorGUILayout.Popup(label, selectedIndex, micDevices) : -1;
            
            if (!EditorGUI.EndChangeCheck()) return;
            Undo.RecordObject(vrmLipSyncContextMorphTarget, nameof(VRMLipSyncContextMorphTarget));
            selectedIndex = index;
            EditorPrefs.SetInt(selectedIndexKey, selectedIndex);
            vrmLipSyncContextMorphTarget.selected = micDevices[index];
        }
    }
#endif
}
```
:::

Inspectorã§è¡¨ç¤ºã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/gmggz0zoc9t3qael359jphmh4r65)

ãã—ã¦ãƒã‚¤ã‚¯ã‚’é¸æŠã™ã‚‹ã¨ãã¯ã“ã†

![](https://storage.googleapis.com/zenn-user-upload/xjs8m3zcg2t9ilh1zeinml62qqxu)

ã“ã‚Œã§ã ã„ã¶æ¥½ã«ãªã‚Šã¾ã—ãŸã€‚

## è»½ã„è§£èª¬

VRMã«åæ˜ ã—ã¦ã„ã‚‹éƒ¨åˆ†ã¯çœãã¾ã™ã€‚

`VRMLipSyncContextMorphTarget.cs` ã‹ã‚‰

```cs
    [RequireComponent(typeof(OVRLipSyncMicInput))]
    // OVRLipSyncMicInputã®Start()ã®å¾Œã«åˆ‡ã‚Šæ›¿ãˆãŸã„ãŸã‚
    [DefaultExecutionOrder(10000)]
    public class VRMLipSyncContextMorphTarget : OVRLipSyncContext
    {

        [SerializeField] private VRMBlendShapeProxy shapeProxy;
        [SerializeField, Range(0.0f, 2.0f)] private float visemesVolume = 2.0f;
        
	// Inspectorã§é¸æŠã—ãŸãƒã‚¤ã‚¯ã®åå‰ã‚’ä¿æŒã™ã‚‹
	[HideInInspector] public string selected;

	~~~ çœç•¥ ~~~

        private void Start()
        {
            // OVRLipSyncMicInputã®åˆæœŸåŒ–ãŒçµ‚ã‚ã£ã¦ã‚‹ã¯ãšãªã®ã§åˆ‡ã‚Šæ›¿ãˆå‡¦ç†ã‚’å…¥ã‚Œã‚‹
            var micInput = GetComponent<OVRLipSyncMicInput>();
            micInput.StopMicrophone();
            micInput.selectedDevice = selected;
            micInput.StartMicrophone();
        }
	
	~~~ çœç•¥ ~~~
```

æ¬¡ã¯ `VRMLipSyncContextMorphTargetEditor`

```cs
    [CustomEditor(typeof(VRMLipSyncContextMorphTarget))]
    public class VRMLipSyncContextMorphTargetEditor : Editor
    {

        private VRMLipSyncContextMorphTarget vrmLipSyncContextMorphTarget;
        private int selectedIndex;
	// EditorPrefsã«ä¿å­˜ã™ã‚‹ã¨ãã®ã‚­ãƒ¼
        private string selectedIndexKey = $"{nameof(VRMLipSyncContextMorphTarget)}.{nameof(selectedIndex)}";

        void OnEnable()
        {
            vrmLipSyncContextMorphTarget = (VRMLipSyncContextMorphTarget)target;
        }

        public override void OnInspectorGUI()
        {
            DrawDefaultInspector();
            
            EditorGUI.BeginChangeCheck();

            selectedIndex = EditorPrefs.GetInt(selectedIndexKey);
            
	    // UnityEngineã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ãƒã‚¤ã‚¯ã®å–å¾—å‡¦ç†
            var micDevices = Microphone.devices;
            var label = "Select Microphone";
	    // Inspectorã§é¸æŠã—ãŸãƒã‚¤ã‚¯ã‚’å–å¾—ã™ã‚‹
            var index = micDevices.Length > 0 && selectedIndex < micDevices.Length ? EditorGUILayout.Popup(label, selectedIndex, micDevices) : -1;
            
	    // Popupã§å¤‰æ›´ãŒãªã‘ã‚Œã°å‡¦ç†ã‚’è¡Œã‚ãªã„
            if (!EditorGUI.EndChangeCheck()) return;
            Undo.RecordObject(vrmLipSyncContextMorphTarget, nameof(VRMLipSyncContextMorphTarget));
            selectedIndex = index;
            EditorPrefs.SetInt(selectedIndexKey, selectedIndex);
	    // VRMLipSyncContextMorphTargetã«ä¿æŒã•ã›ã‚‹
            vrmLipSyncContextMorphTarget.selected = micDevices[index];
        }
    }
```

## ã¾ã¨ã‚

Inspectoræ‹¡å¼µä¹…ã—ã¶ã‚Šã«ã‚„ã‚Šã¾ã—ãŸãŒç°¡å˜ã«é¸æŠUIä½œã‚ŒãŸã®ã§ã‚ˆã‹ã£ãŸã§ã™ã€‚ä½œã£ãŸå¾Œã«ã€åˆ‡ã‚Šæ›¿ãˆãã‚‰ã„å®Ÿã¯åˆ¥Componentã¨ã‹ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ã‚ã‚‹ã®ã§ã¯â€¦ï¼Ÿã¨æ€ã„ã¾ã—ãŸãŒè€ƒãˆãªã„ã“ã¨ã«ã—ã¾ã—ãŸã€‚